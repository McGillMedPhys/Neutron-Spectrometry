# Instructions for `unfold_spectrum.exe`

This application is used to unfold measurements obtained with a Nested Neutron Spectrometer to
obtain a neutron fluence spectrum.

## Table of Contents

* [Input files](#input-files)
    * [Measurements file](#measurements-file)
    * [Settings file](#settings-file)
    * [Energy bins](#energy-bins)
    * [NNS response functions](#nns-response-functions)
    * [Guess spectrum](#guess-spectrum)
    * [Ambient dose equivalent conversion factors](#ambient-dose-equivalent-conversion-factors)
* [Output files](#output-files)
    * [Unfolded spectrum CSV file](#unfolded-spectrum-csv-file)
    * [Unfolded spectrum figure](#unfolded-spectrum-figure)
    * [Unfolding report](#unfolding-report)
* [Settings](#settings)

## Input files

### Measurements file
* This file contains the measured NNS data to be unfolded.
* Default file: `input/measurements.txt`
* Can specify an alternative measurements file within the settings file via the `path_measurements` parameter (described below).
* The required format of the file is shown in `input/template_measurements.txt`.
    * Start with 4 header lines to: (1) describe the measurements, (2) specify delivered dose per moderator shell [MU], (3) specify dose rate used [MU/min], (4) specify the irradiation duration [seconds] 
    * Structure of the data portion is such that measured data can be readily copy/pasted from Google Sheets.
* Input values should already have noise and photon contamination removed.
* If multiple measurements were obtained for the same moderator shell, input them sequentially on subsequent lines and adjust the `num_meas_per_shell` setting accordingly.

### Settings file
* This file contains all of the user-configurable settings for the application.
* Default file: `input/unfold_spectrum.cfg`
* Can specify alternative settings file at runtime via:
```
./unfold_spectrum.exe --configuration <file_name>
```
* The description of each setting is provided in the [Settings Table below](#settings).
* Default values are indicated where applicable.
    * To use default values, **do not delete settings, simply leave the value blank**.

### Energy bins
* This file contains the energies over which the NNS response functions are defined, and thus the energy bins at which unfolded neutron fluence spectra are quantified.
* Units: [MeV]
* The first value is the lowest energy.
* Values are placed on subsequent lines (no commas).
* File is set via the `path_energy_bins` setting.

### NNS response functions
* This file contains the values of the NNS response functions for all eight moderator configurations over the energy range specified in the [energy bins file](#energy-bins).
* The response of a given moderator is presented on a single line, with values separated by commas and from low to high energy.
* Units: [cm<sup>2</sup>]
* The response of the bare detector is on the first line.
* Subsequent lines have the response for the next moderator configuration.
* File is set via the `path_system_response` setting.

### Guess spectrum
* This file contains a guess neutron fluence spectrum used as the starting point of MLEM unfolding, defined over the energy range specified in the [energy bins file](#energy-bins).
* Units: [neutrons cm<sup>-2</sup> s<sup>-1</sup>]
* The first value corresponds to the lowest energy bin.
* Values are placed on subsequent lines (no commas).
* File is set via the `path_input_spectrum` setting.

### Ambient dose equivalent conversion factors
* This file contains the conversion coefficients used to convert from neutron fluence to ambient dose equivalent.
* Units: [pSv cm<sup>2</sup>]
* Values were obtained at the [desired energies](#energy-bins) by linearly interpolating between the tabulated coefficients in Table A.42 of the ICRP 74 report: Conversion Coefficients for use in Radiological Protection against External Radiation.
* The first value corresponds to the lowest energy bin.
* Values are placed on subsequent lines (no commas).
* File is set via the `path_icrp_factors` setting.

## Output files

### Unfolded spectrum CSV file
* This file contains the unfolded neutron fluence spectrum in CSV form that was generated by the unfolding process.
* Units: [neutrons cm<sup>-2</sup> s<sup>-1</sup>]
* The first line of the file contains the comma-separated [energy bins](#energy-bins) [MeV].
* The second line contains the comma-separated values of the unfolded spectrum.
* The third line contains the lower uncertainty values.
* The fourth line contains the upper uncertainty values
* If multiple unfoldings are performed using the same output file, the output spectra and their uncertainties will be appended on new lines to the existing file.
* File is set via the `path_output_spectra` setting.

### Unfolded spectrum figure
* This file contains a plot of the unfolded neutron fluence spectrum (PNG image file).
* Generation of this figure can be toggled off using the `generate_figure` setting.
* Advanced plotting of the spectrum can be performed using [`plot_spectra.exe`](instructions_plot_spectra.md) and the [spectrum CSV file](#unfolded-spectrum-csv-file).
* File is set via the `path_figure` setting.

### Unfolding report
* This file contains a text summary of the unfolding process.
* Includes all pertinent info, including all inputs and outputs.
* Can be used to check and archive previous unfoldings.
* File is set via the `path_report` setting.

## Settings

| Name | Default value | description |
| ---- | ------------- | ----------- |
| `algorithm` | `mlem` | Specify which unfolding algorithm to use.<br>`mlem`: Standard MLEM with a specified  `mlem_max_error` and `mlem_cutoff`.<br>`mlemstop`: use the modified MLEM-STOP criterion ([link to paper](https://doi.org/10.1016/j.nima.2020.163400)).<br>`map`: use *maximum a priori* with a specified `beta` and `prior`. |
| `beta` | `0` | Beta value used in `map` unfolding. |
| `cps_crossover` | `30000` | Crossover (optimal) CPS value used in MLEM-STOP. Default value to be used for linac spectra ([link to paper](https://doi.org/10.1016/j.nima.2020.163400)). |
| `f_factor` | `7.2` | Conversion coefficient between neutron current and CPS for NNS [fA/cps]. |
| `generate_figure` | `1` | `1` = generate figure, `0` = no figure. |
| `generate_report` | `1` | `1` = generate report, `0` = no report. |
| `meas_units` | `nc` |  Specify units of measured values {`nc`,`cps`}. |
| `mlem_cutoff` | `15000` | Maximum # of MLEM iterations. |
| `mlem_max_error` | `0` | Maximum (target) relative error between measured and reconstructed values, below which MLEM terminates. To unfold for a fixed # of iterations, set `algorithm=mlem` and `mlem_max_error=0`, then set `mlem_cutoff` accordingly. |
| `nns_normalization` | `1.14` | NNS-dependent normalization factor. |
| `num_meas_per_shell` | `1` | # of measured values input per moderator shell. |
| `num_uncertainty_samples` | `50` | # of samples generated to determine spectral uncertainty (if `uncertainty_type=poisson` or `gaussian`). |
| `path_energy_bins` | `input/energy_bins.csv` | Pathname to [energy bins file](#energy-bins). |
| `path_figure` | `output/figure_<name>` | Pathname to output [unfolded spectrum figure file](#unfolded-spectrum-figure). `name` determined from measurements file header. |
| `path_icrp_factors` | `input/`<br>`icrp_conversion_coefficients` | Pathname to [file containing ambient dose equivalent conversion coefficients](#ambient-dose-equivalent-conversion-factors) [pSv cm^2]. |
| `path_input_spectrum` | `input/spectrum_step.csv` | Pathname to [input (guess) spectrum file](#guess-spectrum). |
| `path_measurements` | `input/measurements.txt` | Pathname to [NNS measurements file](#measurements-file). |
| `path_output_spectra` | `output/output_spectra.csv` | Pathname to output [unfolded spectrum CSV](#unfolded-spectrum-csv-file) file. |
| `path_report` | `output/report_<name>` | Pathname to output [unfolding report file](#unfolding-report). `name` determined from measurements file header. |
| `path_system_response` | `input/response_nns_he3.csv` | Pathname to [NNS response functions file](#nns-response-functions). |
| `prior` | `mrp` | Type of prior calculation to be done if `algorithm=map`.<br>`quadratic`: smoothing, no edge preservation.<br>`mrp`: median root prior; preserves edges by not penalizing regions of monotonic increase or decrease.<br>`medianrp`: mean root prior; custom written; similar to `mrp` but based on mean of neighbours. |
| `uncertainty_type` | `poisson` | Method used to calculate uncertainty region around the unfolded spectrum {`poisson`,`gaussian`,`j_bounds`}. |
